<div class="page">
    <div class="mat-card-header">
        <div class="mat-card-header-entry"><h1>Experiments</h1></div>
        <div class="mat-card-header-entry">
            <div class="actions">
                <button
                    class="header"
                    mat-icon-button
                    color="primary"
                    (click)="createExperiment()"
                    matTooltip="Create a new experiment"
                >
                    <mat-icon>add</mat-icon>
                </button>
                <button
                    class="header"
                    mat-icon-button
                    color="primary"
                    (click)="refresh()"
                    matTooltip="Refresh the list of experiments"
                >
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
        <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let element">
                {{ element.name }}
            </td>
        </ng-container>

        <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef>User</th>
            <td mat-cell *matCellDef="let element">
                {{ element.user }}
            </td>
        </ng-container>

        <ng-container matColumnDef="start">
            <th mat-header-cell *matHeaderCellDef>Start</th>
            <td mat-cell *matCellDef="let element">
                {{ formatTimeStamp(element.start) }}
            </td>
        </ng-container>

        <ng-container matColumnDef="end">
            <th mat-header-cell *matHeaderCellDef>End</th>
            <td mat-cell *matCellDef="let element">
                {{ formatTimeStamp(element.end) }}
            </td>
        </ng-container>

        <ng-container matColumnDef="devices">
            <th mat-header-cell *matHeaderCellDef>Devices</th>
            <td mat-cell *matCellDef="let element">
                <ng-container *ngIf="element.deviceBookings.length > 1">
                    <p *ngFor="let device of element.deviceBookings">
                        {{ device.deviceName }}
                    </p>
                </ng-container>
                <ng-container *ngIf="element.deviceBookings.length == 1">
                    {{ element.deviceBookings[0].deviceName }}
                </ng-container>
            </td>
        </ng-container>

        <ng-container matColumnDef="script">
            <th mat-header-cell *matHeaderCellDef>Script</th>
            <td mat-cell *matCellDef="let element">
                {{ element.scriptName }}
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="tableColumns"></tr>
        <tr
            mat-row
            class="row"
            *matRowDef="let row; columns: tableColumns; let i = index"
        ></tr>

        <ng-container matColumnDef="edit">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let element; let i = index">
                <div class="edit">
                    <button mat-icon-button
                            (click)="startExperiment(i)"
                            matTooltip="Start experiment now">
                        <mat-icon>play_arrow</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="stopExperiment(i)"
                            matTooltip="Stop experiment">
                        <mat-icon>stop</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="edit(i)"
                            matTooltip="Edit experiment">
                        <mat-icon>create</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="delete(i)"
                            matTooltip="Delete experiment">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            </td>
        </ng-container>
        <ng-container matColumnDef="running">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let element; let i = index">
                <!--div
                    *ngIf="let status=experimentStatus$|async;status.experimentId==i"
                -->
                <ng-container
                    *ngIf="experimentStatus$ | async as status; else unknown"
                >
                    <div
                        *ngIf="status.experimentId == element.id; else unknown"
                    >
                        {{ statusMap[status.status] }}
                    </div>
                </ng-container>
                <ng-template #unknown>
                    <div>unknown</div>
                </ng-template>
            </td>
        </ng-container>
    </table>
</div>
